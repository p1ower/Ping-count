{"file_contents":{"main.py":{"content":"#!/usr/bin/env python3\n# role_ping_csvbot.py\n# Discord.py v2.3+ ‚Äî ohne SQL, nutzt CSV\n# pip install -U discord.py\n\nimport discord\nfrom discord import app_commands\nfrom discord.ext import commands\nimport csv\nimport os\nfrom datetime import datetime\nfrom collections import Counter, defaultdict\n\nTOKEN = os.environ['PING_COUNT_TOKEN']  # <-- hier Token eintragen\nCSV_PATH = \"role_pings.csv\"\n\nintents = discord.Intents.default()\nintents.message_content = True\nintents.guilds = True\nintents.members = True\n\nbot = commands.Bot(command_prefix=\"!\", intents=intents)\n\n\n# ---------- CSV Handling ----------\ndef ensure_csv_exists():\n    \"\"\"Erstellt die CSV-Datei, falls sie fehlt.\"\"\"\n    print(\"Ensuring CSV exists...\")\n    if not os.path.exists(CSV_PATH):\n        try:\n            with open(CSV_PATH, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n                writer = csv.writer(f)\n                writer.writerow([\n                    \"guild_id\", \"role_id\", \"user_id\", \"channel_id\", \"timestamp\"\n                ])\n        except Exception as e:\n            print(f\"Error creating CSV: {e}\")\n\n\ndef append_ping(guild_id, role_id, user_id, channel_id):\n    \"\"\"F√ºgt einen neuen Eintrag hinzu.\"\"\"\n    print(f\"Appending ping: {guild_id}, {role_id}, {user_id}, {channel_id}\")\n    ensure_csv_exists()\n    try:\n        with open(CSV_PATH, \"a\", newline=\"\", encoding=\"utf-8\") as f:\n            writer = csv.writer(f)\n            writer.writerow([\n                guild_id, role_id, user_id, channel_id,\n                datetime.utcnow().isoformat()\n            ])\n    except Exception as e:\n        print(f\"Error appending ping: {e}\")\n\n\ndef read_all_pings():\n    \"\"\"Liest alle Eintr√§ge in eine Liste von Dicts.\"\"\"\n    ensure_csv_exists()\n    with open(CSV_PATH, \"r\", encoding=\"utf-8\") as f:\n        reader = csv.DictReader(f)\n        return list(reader)\n\n\ndef write_all_pings(rows):\n    \"\"\"Schreibt eine komplette Liste von Dicts zur√ºck in die CSV.\"\"\"\n    with open(CSV_PATH, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n        writer = csv.DictWriter(f,\n                                fieldnames=[\n                                    \"guild_id\", \"role_id\", \"user_id\",\n                                    \"channel_id\", \"timestamp\"\n                                ])\n        writer.writeheader()\n        writer.writerows(rows)\n\n\n# ---------- Datenabfragen ----------\ndef get_top_for_role(guild_id, role_id, limit=10):\n    rows = read_all_pings()\n    counts = Counter()\n    for row in rows:\n        if row[\"guild_id\"] == str(guild_id) and row[\"role_id\"] == str(role_id):\n            counts[row[\"user_id\"]] += 1\n    return counts.most_common(limit)\n\n\ndef get_counts_for_user(guild_id, user_id):\n    rows = read_all_pings()\n    counts = Counter()\n    for row in rows:\n        if row[\"guild_id\"] == str(guild_id) and row[\"user_id\"] == str(user_id):\n            counts[row[\"role_id\"]] += 1\n    return counts.most_common()\n\n\ndef reset_role_counts(guild_id, role_id):\n    rows = read_all_pings()\n    new_rows = [\n        r for r in rows if not (\n            r[\"guild_id\"] == str(guild_id) and r[\"role_id\"] == str(role_id))\n    ]\n    write_all_pings(new_rows)\n\n\ndef reset_user_counts(guild_id, user_id):\n    rows = read_all_pings()\n    new_rows = [\n        r for r in rows if not (\n            r[\"guild_id\"] == str(guild_id) and r[\"user_id\"] == str(user_id))\n    ]\n    write_all_pings(new_rows)\n\n\n# ---------- Events ----------\n@bot.event\nasync def on_ready():\n    ensure_csv_exists()\n    await bot.tree.sync()\n    print(f\"‚úÖ Logged in as {bot.user} ‚Äî Slash Commands synced.\")\n\n\n@bot.event\nasync def on_message(message: discord.Message):\n    if message.author.bot or not message.guild:\n        return\n\n    for role in message.role_mentions:\n        if not role.mentionable:\n            continue  # Nur pingbare Rollen\n        append_ping(guild_id=message.guild.id,\n                    role_id=role.id,\n                    user_id=message.author.id,\n                    channel_id=message.channel.id)\n\n\n# ---------- Slash Commands ----------\n@bot.tree.command(name=\"help\", description=\"Show available commands\")\nasync def help_cmd(interaction: discord.Interaction):\n    embed = discord.Embed(title=\"üìò Role Ping Counter ‚Äî Help\",\n                          color=discord.Color.blurple())\n    embed.description = (\n        \"/rolecounts @Role ‚Äî Show top users who pinged that role.\\n\"\n        \"/leaderboard @Role ‚Äî Alias for /rolecounts.\\n\"\n        \"/mycounts ‚Äî Show your personal role ping stats.\\n\"\n        \"/resetcounts @Role ‚Äî Reset counts for that role (Admin only).\\n\"\n        \"/resetmycounts ‚Äî Delete all your counts.\\n\")\n    await interaction.response.send_message(embed=embed, ephemeral=True)\n\n\n@bot.tree.command(name=\"rolecounts\",\n                  description=\"Show top users who pinged a specific role\")\n@app_commands.describe(role=\"Select a role to view stats for\")\nasync def rolecounts(interaction: discord.Interaction, role: discord.Role):\n    top_users = get_top_for_role(interaction.guild.id, role.id)\n    if not top_users:\n        await interaction.response.send_message(\n            f\"No data yet for {role.mention}.\", ephemeral=True)\n        return\n\n    lines = []\n    for user_id, total in top_users:\n        member = interaction.guild.get_member(int(user_id))\n        name = member.display_name if member else f\"<User {user_id}>\"\n        lines.append(f\"**{total}x** ‚Äî {name}\")\n\n    embed = discord.Embed(title=f\"üèÜ Top Role Pingers ‚Äî {role.name}\",\n                          color=discord.Color.blurple())\n    embed.description = \"\\n\".join(lines)\n    await interaction.response.send_message(embed=embed)\n\n\n@bot.tree.command(name=\"leaderboard\", description=\"Alias for /rolecounts\")\nasync def leaderboard(interaction: discord.Interaction, role: discord.Role):\n    await rolecounts(interaction, role)\n\n\n@bot.tree.command(name=\"mycounts\", description=\"Show your personal ping stats\")\nasync def mycounts(interaction: discord.Interaction):\n    counts = get_counts_for_user(interaction.guild.id, interaction.user.id)\n    if not counts:\n        await interaction.response.send_message(\n            \"You haven't pinged any roles yet.\", ephemeral=True)\n        return\n\n    lines = []\n    for role_id, total in counts:\n        role = interaction.guild.get_role(int(role_id))\n        rname = role.name if role else f\"<Deleted Role {role_id}>\"\n        lines.append(f\"**{total}x** ‚Äî {rname}\")\n\n    embed = discord.Embed(\n        title=f\"üìä Your Ping Stats ‚Äî {interaction.user.display_name}\",\n        color=discord.Color.green())\n    embed.description = \"\\n\".join(lines)\n    await interaction.response.send_message(embed=embed, ephemeral=True)\n\n\n@bot.tree.command(name=\"resetcounts\",\n                  description=\"Reset all counts for a role (Admin only)\")\n@app_commands.checks.has_permissions(manage_guild=True)\nasync def resetcounts(interaction: discord.Interaction, role: discord.Role):\n    reset_role_counts(interaction.guild.id, role.id)\n    await interaction.response.send_message(\n        f\"‚úÖ Counts for {role.mention} have been reset.\", ephemeral=True)\n\n\n@bot.tree.command(name=\"resetmycounts\",\n                  description=\"Reset your personal counts\")\nasync def resetmycounts(interaction: discord.Interaction):\n    reset_user_counts(interaction.guild.id, interaction.user.id)\n    await interaction.response.send_message(\"‚úÖ Your counts have been reset.\",\n                                            ephemeral=True)\n\n\n# ---------- Run ----------\nif __name__ == \"__main__\":\n    ensure_csv_exists()\n    bot.run(TOKEN)\n","size_bytes":7533},"pyproject.toml":{"content":"[project]\nname = \"python-template\"\nversion = \"0.1.0\"\ndescription = \"\"\nauthors = [\"Your Name <you@example.com>\"]\nrequires-python = \">=3.11\"\ndependencies = [\n    \"discord-py>=2.6.4\",\n]\n","size_bytes":183}},"version":2}